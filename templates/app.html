<!DOCTYPE html>
<!-- Updated: Mobile layout fix v2 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATOM - Automated Tasks & Operations Manager - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/professional-theme.css') }}?v=2">
    <!-- Monaco Editor CSS -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css">
    <style>
        body {
            background-color: #FAFAFA;
            margin: 0;
            padding: 0;
        }
        
        /* Header Styles */
        .header {
            background-color: #232F3E;
            color: white;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 56px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 400;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .logo-accent {
            color: #FF9900;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }
        
        .user-info {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        
        .logout-btn {
            background-color: #37475A;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.15s;
            white-space: nowrap;
        }
        
        .logout-btn:hover {
            background-color: #545B64;
        }
        
        /* Mobile Header Styles */
        @media (max-width: 768px) {
            .header-container {
                padding: 0 12px;
                height: 56px;
            }
            
            .logo {
                font-size: 16px;
            }
            
            .logo-accent {
                font-weight: 700;
            }
            
            .logo-text {
                display: inline-block;
            }
            
            .user-menu {
                gap: 8px;
            }
            
            .user-info {
                font-size: 12px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 120px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .header-container {
                padding: 0 8px;
            }
            
            .logo {
                font-size: 14px;
            }
            
            .logo-text {
                display: none; /* Hide "Automation Suite" text on very small screens */
            }
            
            .logo-mobile {
                display: inline-block;
            }
            
            .user-info {
                max-width: 100px;
                font-size: 11px;
            }
            
            .user-info-text {
                display: none; /* Hide "Welcome" text on very small screens */
            }
            
            .user-info-name {
                font-weight: 600;
            }
            
            .logout-btn {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
        
        @media (min-width: 481px) {
            .logo-mobile {
                display: none;
            }
            
            .user-info-text {
                display: inline;
            }
        }
        
        /* Main Content */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .page-header {
            margin-bottom: 24px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 300;
            color: #16191F;
            margin: 0 0 8px 0;
        }
        
        .page-description {
            color: #697078;
            font-size: 14px;
        }
        
        /* Enhanced Tab Styles */
        .tabs-container {
            background: white;
            border: 1px solid #E3E6E8;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            background-color: #F2F3F3;
            border-bottom: 1px solid #E3E6E8;
            padding: 0 16px;
        }
        
        .tab {
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #545B64;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            position: relative;
        }
        
        .tab:hover {
            color: #16191F;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .tab.active {
            color: #146EB4;
            background-color: white;
            border-bottom-color: #FF9900;
        }
        
        .tab-content {
            display: none;
            padding: 32px;
            background: white;
            min-height: 400px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        /* Form Enhancements */
        .form-section {
            max-width: 800px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #37475A;
            font-size: 14px;
        }
        
        .form-label .required {
            color: #D91515;
        }
        
        .form-help {
            margin-top: 6px;
            font-size: 12px;
            color: #697078;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #C4CDD5;
            border-radius: 4px;
            background-color: white;
            transition: all 0.15s;
        }
        
        .form-control:focus {
            border-color: #146EB4;
            box-shadow: 0 0 0 3px rgba(20, 110, 180, 0.1);
            outline: none;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23545B64' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        /* Button Styles */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 10px 20px;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 4px;
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }
        
        .btn-primary {
            color: white;
            background-color: #FF9900;
            border-color: #FF9900;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #EC7211;
            border-color: #EC7211;
        }
        
        .btn-secondary {
            color: #37475A;
            background-color: white;
            border-color: #C4CDD5;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #F2F3F3;
            border-color: #879196;
        }
        
        .btn-success {
            color: white;
            background-color: #037F0C;
            border-color: #037F0C;
        }
        
        .btn-info {
            color: white;
            background-color: #0073BB;
            border-color: #0073BB;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        /* Status Messages */
        .alert {
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert-success {
            color: #0F5132;
            background-color: #D1E7DD;
            border-color: #037F0C;
            border-left: 4px solid #037F0C;
        }
        
        .alert-error {
            color: #842029;
            background-color: #F8D7DA;
            border-color: #D91515;
            border-left: 4px solid #D91515;
        }
        
        .alert-info {
            color: #0C5460;
            background-color: #D1ECF1;
            border-color: #0073BB;
            border-left: 4px solid #0073BB;
        }
        
        .alert-warning {
            color: #664D03;
            background-color: #FFF3CD;
            border-color: #FF9900;
            border-left: 4px solid #FF9900;
        }
        
        /* Progress Indicator */
        .progress-container {
            margin-top: 24px;
            display: none;
        }
        
        .progress {
            height: 8px;
            background-color: #E3E6E8;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #146EB4;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-bar.animated {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            from { background-position: 40px 0; }
            to { background-position: 0 0; }
        }
        
        .progress-text {
            color: #545B64;
            font-size: 14px;
        }
        
        /* Step List */
        .step-list {
            margin-top: 24px;
            padding: 0;
            list-style: none;
        }
        
        .step-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            background-color: #FAFAFA;
            border-radius: 4px;
            border-left: 4px solid #C4CDD5;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .step-item.completed {
            border-left-color: #037F0C;
            background-color: #F0FDF4;
        }
        
        .step-item.completed .step-icon {
            color: #037F0C;
        }
        
        .step-item.in-progress {
            border-left-color: #FF9900;
            background-color: #FFFBEB;
        }
        
        .step-item.in-progress .step-icon {
            color: #FF9900;
            animation: spin 1s linear infinite;
        }
        
        .step-item.failed {
            border-left-color: #D91515;
            background-color: #FEF2F2;
        }
        
        .step-item.failed .step-icon {
            color: #D91515;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Domain Section */
        .domain-section {
            margin-top: 32px;
            padding: 24px;
            background-color: #F2F3F3;
            border: 1px solid #E3E6E8;
            border-radius: 8px;
        }
        
        .domain-section h3 {
            margin: 0 0 16px 0;
            color: #16191F;
            font-size: 18px;
            font-weight: 500;
        }
        
        .manual-steps {
            margin-top: 20px;
            padding: 16px;
            background-color: #FFF3CD;
            border: 1px solid #FFECB5;
            border-radius: 4px;
            border-left: 4px solid #FF9900;
        }
        
        .manual-steps h4 {
            margin: 0 0 12px 0;
            color: #664D03;
            font-size: 16px;
        }
        
        .manual-steps code {
            background-color: #F2F3F3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
        }
        
        /* Navigation Pills */
        .nav-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .nav-pill, .option-button {
            padding: 8px 16px;
            background-color: white;
            border: 1px solid #C4CDD5;
            border-radius: 20px;
            color: #37475A;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .nav-pill:hover, .option-button:hover {
            background-color: #F2F3F3;
            border-color: #879196;
        }
        
        .nav-pill.active, .option-button.active {
            background-color: #146EB4;
            border-color: #146EB4;
            color: white;
        }
        
        .option-content {
            display: none;
        }
        
        .option-content.active {
            display: block;
        }
        
        /* File Tree Styles */
        .file-tree {
            background-color: #F2F3F3;
            border: 1px solid #E3E6E8;
            border-radius: 4px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .folder-item {
            margin: 4px 0;
        }
        
        .folder-header {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            background-color: white;
            border-radius: 4px;
            transition: background-color 0.15s;
        }
        
        .folder-header:hover {
            background-color: #F2F3F3;
        }
        
        .folder-content {
            margin-left: 24px;
            padding: 4px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            margin: 2px 0;
            background-color: white;
            border-radius: 4px;
            font-size: 13px;
            transition: background-color 0.15s;
        }
        
        .file-item:hover {
            background-color: #E3E6E8;
        }
        
        .file-item.selected {
            background-color: #146EB4;
            color: white;
        }
        
        .folder-icon, .file-icon {
            margin-right: 8px;
            color: #697078;
        }
        
        .expand-btn {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            color: #697078;
        }
        
        /* Checkbox styles for file copier */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            margin-right: 8px;
        }
        
        /* Editor Styles - ENHANCED */
        .editor-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            height: 600px;
        }
        
        .editor-sidebar {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
        }
        
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .editor-wrapper {
            flex: 1;
            border: 1px solid #E3E6E8;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .editor-controls {
            background-color: #F2F3F3;
            border-bottom: 1px solid #E3E6E8;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .editor-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .editor-search-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .search-input {
            padding: 6px 10px;
            border: 1px solid #C4CDD5;
            border-radius: 4px;
            font-size: 13px;
            width: 150px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #FAFAFA;
            border-bottom: 1px solid #E3E6E8;
        }
        
        .editor-title {
            font-size: 14px;
            font-weight: 500;
            color: #16191F;
        }
        
        .editor-content {
            flex: 1;
            position: relative;
            background: white;
            min-height: 450px;
        }
        
        #monaco-file-editor {
            width: 100%;
            height: 450px;
            min-height: 450px;
            display: block;
            position: relative;
            visibility: visible;
            background-color: #ffffff;
            border: 1px solid #E3E6E8;
        }
        
        #basic-file-content {
            width: 100%;
            height: 450px;
            min-height: 450px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 12px;
            border: none;
            resize: none;
            display: block;
            background-color: #ffffff;
        }
        
        .editor-status-bar {
            padding: 8px 16px;
            background-color: #F2F3F3;
            border-top: 1px solid #E3E6E8;
            font-size: 12px;
            color: #697078;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-info {
            display: flex;
            gap: 16px;
        }
        
        /* Status display */
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        
        .status.success {
            background-color: #D1E7DD;
            color: #0F5132;
            border: 1px solid #BADBCC;
            display: block;
        }
        
        .status.error {
            background-color: #F8D7DA;
            color: #842029;
            border: 1px solid #F5C2C7;
            display: block;
        }
        
        .status.info {
            background-color: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
            display: block;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            .main-container {
                padding: 12px;
                max-width: 100%;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                white-space: nowrap;
                padding: 0 8px;
                margin-bottom: 16px;
                display: flex;
                gap: 4px;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 10px 14px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            .tab-content {
                padding: 16px;
            }
            
            .header-container {
                padding: 0 12px;
            }
            
            /* File Editor Mobile Layout - Stack vertically */
            #file-editor .editor-container {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
                gap: 12px;
            }
            
            #file-editor .editor-sidebar {
                flex: none !important;
                width: 100% !important;
                max-width: 100% !important;
                max-height: 350px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                border: 1px solid #E3E6E8;
                border-radius: 4px;
                padding: 12px;
                background: white;
                margin-bottom: 12px;
                order: 1;
            }
            
            .file-tree {
                max-height: 250px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 13px;
                background: white;
                padding: 8px;
            }
            
            .folder-item {
                font-size: 13px;
                margin: 2px 0;
            }
            
            .folder-header {
                padding: 6px 8px;
                background: #F2F3F3;
                border-radius: 4px;
                margin-bottom: 2px;
            }
            
            .folder-contents {
                padding-left: 16px;
            }
            
            .file-item {
                padding: 6px 8px;
                font-size: 13px;
                margin: 2px 0;
            }
            
            #file-editor .editor-main {
                width: 100% !important;
                max-width: 100% !important;
                min-height: 400px;
                display: block !important;
                visibility: visible !important;
                order: 2;
                margin: 0 !important;
            }
            
            .editor-wrapper {
                height: 400px;
                display: block !important;
                visibility: visible !important;
            }
            
            .editor-content {
                display: block !important;
                visibility: visible !important;
                min-height: 300px !important;
            }
            
            #monaco-file-editor {
                height: 350px !important;
                width: 100% !important;
                display: block !important;
                visibility: visible !important;
                position: relative !important;
            }
            
            #file-editor {
                height: 350px !important;
                width: 100% !important;
            }
            
            .editor-controls {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px;
            }
            
            .editor-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                width: 100%;
            }
            
            .editor-actions .btn-sm {
                padding: 6px 10px;
                font-size: 12px;
                flex: 0 0 auto;
            }
            
            .search-replace {
                width: 100%;
                display: flex;
                flex-direction: row;
                gap: 8px;
            }
            
            .search-replace input {
                flex: 1;
                min-width: 0;
                font-size: 14px;
            }
            
            .status-bar {
                font-size: 11px;
                padding: 6px 8px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .status-bar > span {
                flex-shrink: 0;
            }
            
            /* Fix form elements on mobile */
            .form-control, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* Better touch targets */
                width: 100%;
            }
            
            .card {
                margin-bottom: 12px;
            }
            
            .card-body {
                padding: 12px;
            }
            
            /* Footer on mobile */
            div[style*="background-color: #232F3E"] {
                margin-top: 20px !important;
                padding: 16px 8px !important;
            }
            
            div[style*="background-color: #232F3E"] p {
                font-size: 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .main-container {
                padding: 8px;
            }
            
            /* Ensure vertical stacking on small screens */
            #file-editor .editor-container {
                display: block !important;
            }
            
            #file-editor .editor-sidebar,
            #file-editor .editor-main {
                display: block !important;
                width: 100% !important;
                margin-bottom: 16px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .page-description {
                font-size: 12px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .editor-sidebar {
                max-height: 300px;
                padding: 10px;
            }
            
            .file-tree {
                max-height: 200px;
                font-size: 12px;
            }
            
            .folder-header,
            .file-item {
                padding: 5px 6px;
                font-size: 12px;
            }
            
            .editor-wrapper {
                height: 350px;
            }
            
            #monaco-file-editor, #file-editor {
                height: 300px !important;
            }
            
            .btn-sm {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .search-replace input {
                font-size: 13px;
                padding: 6px;
            }
            
            .status-bar {
                font-size: 10px;
                padding: 5px 6px;
            }
            
            .form-control, .form-select {
                min-height: 40px;
                font-size: 14px;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <div class="logo">
                <span class="logo-accent">ATOM</span>
                <span class="logo-text"> - Automated Tasks & Operations Manager</span>
                <span class="logo-mobile"></span>
            </div>
            <div class="user-menu">
                <span class="user-info">
                    <span class="user-info-text">Welcome, </span>
                    <span class="user-info-name">{{ current_user.name }}</span>
                </span>
                <a href="{{ url_for('logout') }}" class="logout-btn">Sign Out</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">ATOM Infrastructure Manager</h1>
            <p class="page-description">Automate your cloud infrastructure setup and management</p>
        </div>

        <div class="tabs-container">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab active" data-tab="domain-setup">Domain Setup</button>
                <button class="tab" data-tab="script-management">Script Management</button>
                <button class="tab" data-tab="file-copier">File Copier</button>
                <button class="tab" data-tab="file-editor">File Editor</button>
                <button class="tab" data-tab="w3bcopier">W3bCopier</button>
            </div>

            <!-- Domain Setup Tab -->
            <div id="domain-setup" class="tab-content active">
                <div class="form-section">
                    <h3 style="margin-top: 0; color: #16191F; font-weight: 500;">Setup New Domain</h3>
                    <p style="color: #697078; font-size: 14px; margin-bottom: 24px;">
                        Configure CloudFront distribution and Route 53 for your domain
                    </p>
                    
                    <form id="domainForm">
                        <div class="form-group">
                            <label for="account-select" class="form-label">
                                AWS Account <span class="required">*</span>
                            </label>
                            <select id="account-select" class="form-control form-select" required>
                                <option value="">Select an AWS account...</option>
                            </select>
                            <div class="form-help">Choose the AWS account where resources will be created</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="domain" class="form-label">
                                Domain Name(s) <span class="required">*</span>
                            </label>
                            <input type="text" id="domain" class="form-control" 
                                   placeholder="example.com or multiple: example1.com, example2.com" required>
                            <div class="form-help">Enter one or multiple domain names separated by commas</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">
                            Start Domain Setup
                        </button>
                    </form>
                    
                    <div id="domainStatus" class="status" style="display: none;"></div>
                    <div id="progressContainer" class="progress-container">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar animated" style="width: 0%"></div>
                        </div>
                        <div id="progressText" class="progress-text">Initializing...</div>
                    </div>
                    <ul id="stepList" class="step-list"></ul>
                    <div id="domainSection" class="domain-section" style="display: none;"></div>
                </div>
            </div>

            <!-- Script Management Tab -->
            <div id="script-management" class="tab-content">
                <div class="form-section">
                    <h3 style="margin-top: 0; color: #16191F; font-weight: 500;">Script Management</h3>
                    <p style="color: #697078; font-size: 14px; margin-bottom: 24px;">
                        Manage scripts in your S3 bucket HTML files
                    </p>
                    
                    <div class="form-group">
                        <label for="script-account-select" class="form-label">AWS Account</label>
                        <select id="script-account-select" class="form-control form-select">
                            <option value="">Select an account...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="bucket-select" class="form-label">S3 Bucket</label>
                        <select id="bucket-select" class="form-control form-select">
                            <option value="">Select a bucket...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-select" class="form-label">HTML File</label>
                        <select id="file-select" class="form-control form-select">
                            <option value="">Select a file...</option>
                        </select>
                    </div>
                    
                    <div class="nav-pills">
                        <button class="option-button active" data-option="replace-script">Replace Script</button>
                        <button class="option-button" data-option="add-script">Add Script</button>
                    </div>
                    
                    <!-- Replace Script Option -->
                    <div id="replace-script" class="option-content active">
                        <div class="form-group">
                            <label for="find-text" class="form-label">Find Text</label>
                            <textarea id="find-text" class="form-control" rows="4" 
                                      placeholder="Enter the text to find..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="replace-text" class="form-label">Replace With</label>
                            <textarea id="replace-text" class="form-control" rows="4" 
                                      placeholder="Enter the replacement text..."></textarea>
                        </div>
                        
                        <button id="replace-script-btn" class="btn btn-primary btn-block">Replace Script</button>
                    </div>
                    
                    <!-- Add Script Option -->
                    <div id="add-script" class="option-content">
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <div class="nav-pills">
                                <button class="option-button active" data-script-location="head">Head Tag</button>
                                <button class="option-button" data-script-location="body">Body Tag</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="script-text" class="form-label">Script to Add</label>
                            <textarea id="script-text" class="form-control" rows="6" 
                                      placeholder="Enter the script to add..."></textarea>
                        </div>
                        
                        <button id="add-script-btn" class="btn btn-primary btn-block">Add Script</button>
                    </div>
                    
                    <div id="scriptStatus" class="status" style="display: none;"></div>
                </div>
            </div>

            <!-- File Copier Tab -->
            <div id="file-copier" class="tab-content">
                <div class="form-section">
                    <h3 style="margin-top: 0; color: #16191F; font-weight: 500;">File Copier</h3>
                    <p style="color: #697078; font-size: 14px; margin-bottom: 24px;">
                        Copy files between S3 buckets with advanced options
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="source-account-select" class="form-control form-select" style="flex: 1;">
                                <option value="">Select account...</option>
                            </select>
                            <select id="source-bucket-select" class="form-control form-select" style="flex: 1;">
                                <option value="">Select bucket...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="target-account-select" class="form-control form-select" style="flex: 1;">
                                <option value="">Select account...</option>
                            </select>
                            <select id="target-bucket-select" class="form-control form-select" style="flex: 1;">
                                <option value="">Select bucket...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Files to Copy</label>
                        <div id="source-files" class="file-tree">
                            <p style="color: #697078; text-align: center;">Select source bucket to load files</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="enable-search-replace"> Enable Search & Replace
                        </label>
                        <div id="search-replace-options" style="display: none; margin-top: 16px;">
                            <div class="form-group">
                                <label for="search-terms" class="form-label">Search Terms (comma separated)</label>
                                <input type="text" id="search-terms" class="form-control" 
                                       placeholder="oldterm1, oldterm2, oldterm3">
                            </div>
                            <div class="form-group">
                                <label for="replace-terms" class="form-label">Replace Terms (comma separated)</label>
                                <input type="text" id="replace-terms" class="form-control" 
                                       placeholder="newterm1, newterm2, newterm3">
                            </div>
                        </div>
                    </div>
                    
                    <button id="copy-files-btn" class="btn btn-primary btn-block">Copy Selected Files</button>
                    
                    <div id="copyStatus" class="status" style="display: none;"></div>
                </div>
            </div>

            <!-- File Editor Tab - ENHANCED -->
            <div id="file-editor" class="tab-content">
                <h3 style="margin-top: 0; color: #16191F; font-weight: 500;">Advanced File Editor</h3>
                <p style="color: #697078; font-size: 14px; margin-bottom: 24px;">
                    Edit files directly in your S3 buckets with advanced search and replace capabilities
                </p>
                
                <div class="editor-container">
                    <!-- Left Sidebar - File Tree -->
                    <div class="editor-sidebar">
                        <div class="form-group">
                            <label for="edit-account-select" class="form-label">AWS Account</label>
                            <select id="edit-account-select" class="form-control form-select">
                                <option value="">Select account...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-bucket-select" class="form-label">S3 Bucket</label>
                            <select id="edit-bucket-select" class="form-control form-select">
                                <option value="">Select bucket...</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                            <label class="form-label">Files</label>
                            <div id="file-tree" class="file-tree" style="flex: 1;">
                                <p style="color: #697078; text-align: center;">Select bucket to load files</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Editor -->
                    <div class="editor-main">
                        <div class="editor-wrapper">
                            <!-- Editor Controls -->
                            <div class="editor-controls">
                                <div class="editor-actions">
                                    <button id="save-button" class="btn btn-primary btn-sm" disabled>
                                        💾 Save
                                    </button>
                                    <button id="reload-button" class="btn btn-secondary btn-sm" disabled>
                                        🔄 Reload
                                    </button>
                                    <button id="format-button" class="btn btn-secondary btn-sm" disabled>
                                        📐 Format
                                    </button>
                                </div>
                                
                                <div class="editor-search-controls">
                                    <input type="text" id="search-in-file" class="search-input" placeholder="Find...">
                                    <input type="text" id="replace-in-file" class="search-input" placeholder="Replace...">
                                    <button id="find-next-btn" class="btn btn-secondary btn-sm">Find</button>
                                    <button id="replace-btn" class="btn btn-secondary btn-sm">Replace</button>
                                    <button id="replace-all-btn" class="btn btn-secondary btn-sm">All</button>
                                </div>
                            </div>
                            
                            <!-- Editor Header -->
                            <div class="editor-header">
                                <span class="editor-title" id="current-file">No file selected</span>
                                <span id="editor-mode" style="font-size: 12px; color: #697078;">Plain Text</span>
                            </div>
                            
                            <!-- Editor Content -->
                            <div class="editor-content">
                                <!-- Monaco Editor will be loaded here if available -->
                                <div id="monaco-file-editor"></div>
                                <!-- Fallback to basic textarea -->
                                <textarea id="basic-file-content" class="form-control" 
                                          placeholder="Select a file to edit..."></textarea>
                            </div>
                            
                            <!-- Status Bar -->
                            <div class="editor-status-bar">
                                <div class="editor-info">
                                    <span id="line-info">Line 1, Col 1</span>
                                    <span id="char-count">0 characters</span>
                                    <span id="encoding">UTF-8</span>
                                </div>
                                <div>
                                    <span id="editor-status">Ready</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="editorStatus" class="status" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- W3bCopier Tab -->
            <div id="w3bcopier" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #16191F; font-weight: 500; margin-bottom: 16px;">W3bCopier Tool</h3>
                    <p style="color: #697078; margin-bottom: 24px;">Advanced website scraping and cloning capabilities</p>
                    <a href="/w3bcopier" class="btn btn-primary" target="_blank">
                        Open W3bCopier Interface
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Global variables
        let debugLog = [];
        let monacoEditor = null;
        let currentFileKey = null;
        let currentBucketName = null;
        let currentAccountKey = null;
        let hasUnsavedChanges = false;
        
        // Debug logging
        function log(message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry, data);
            
            debugLog.push(logEntry);
            if (data) {
                debugLog.push(JSON.stringify(data, null, 2));
            }
            
            if (debugLog.length > 100) {
                debugLog = debugLog.slice(-100);
            }
        }
        
        // Initialize Monaco Editor
        function initMonacoEditor() {
            if (monacoEditor) return;
            
            // Make the editor container visible immediately
            const monacoContainer = document.getElementById('monaco-file-editor');
            const basicTextarea = document.getElementById('basic-file-content');
            
            if (monacoContainer) {
                // Ensure container is visible and has dimensions
                monacoContainer.style.display = 'block';
                monacoContainer.style.width = '100%';
                monacoContainer.style.height = '450px';
                monacoContainer.style.minHeight = '450px';
                
                // Initially show basic textarea as fallback
                if (basicTextarea) {
                    basicTextarea.style.display = 'block';
                }
            }
            
            // Try to load Monaco Editor
            try {
                if (typeof require === 'undefined') {
                    // Load require.js first
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js';
                    script.onload = function() {
                        loadMonaco();
                    };
                    script.onerror = function() {
                        console.error('Failed to load require.js, falling back to textarea');
                        useBasicEditor();
                    };
                    document.head.appendChild(script);
                } else {
                    loadMonaco();
                }
            } catch (error) {
                console.error('Error initializing Monaco:', error);
                useBasicEditor();
            }
        }
        
        function useBasicEditor() {
            // Fall back to basic textarea
            const basicTextarea = document.getElementById('basic-file-content');
            const monacoContainer = document.getElementById('monaco-file-editor');
            
            if (basicTextarea) {
                basicTextarea.style.display = 'block';
            }
            if (monacoContainer) {
                monacoContainer.style.display = 'none';
            }
        }
        
        function loadMonaco() {
            require.config({ 
                paths: { 
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
                }
            });
            
            require(['vs/editor/editor.main'], function() {
                const monacoContainer = document.getElementById('monaco-file-editor');
                const basicTextarea = document.getElementById('basic-file-content');
                
                if (monacoContainer && !monacoEditor) {
                    // Hide the basic textarea now that Monaco is loading
                    if (basicTextarea) {
                        basicTextarea.style.display = 'none';
                    }
                    
                    // Editor container is already visible from initMonacoEditor()
                    
                    // Determine if we're on mobile
                    const isMobile = window.innerWidth <= 768;
                    
                    // Create welcome content
                    const welcomeContent = `// Welcome to ATOM File Editor
// 
// Getting Started:
// 1. Select an AWS account from the dropdown above
// 2. Choose an S3 bucket from your account
// 3. Browse and select a file from the file tree
// 4. Edit your file with syntax highlighting and auto-completion
// 5. Save your changes directly to S3
//
// Keyboard Shortcuts:
// - Save: Ctrl+S (Cmd+S on Mac)
// - Find: Ctrl+F (Cmd+F on Mac)
// - Replace: Ctrl+H (Cmd+H on Mac)
// - Format: Shift+Alt+F (Shift+Option+F on Mac)
//
// Select a file from the tree to begin editing...`;
                    
                    monacoEditor = monaco.editor.create(monacoContainer, {
                        value: welcomeContent,
                        language: 'javascript',
                        theme: 'vs',
                        automaticLayout: true,
                        fontSize: isMobile ? 12 : 14,
                        minimap: { enabled: !isMobile },
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                        lineNumbers: 'on',
                        renderWhitespace: 'selection',
                        quickSuggestions: !isMobile,
                        suggestOnTriggerCharacters: !isMobile,
                        acceptSuggestionOnEnter: 'on',
                        tabCompletion: 'on',
                        folding: !isMobile,
                        glyphMargin: !isMobile,
                        find: {
                            seedSearchStringFromSelection: true,
                            autoFindInSelection: 'always'
                        }
                    });
                    
                    // Track changes
                    monacoEditor.onDidChangeModelContent(() => {
                        if (!hasUnsavedChanges) {
                            hasUnsavedChanges = true;
                            document.getElementById('save-button').disabled = false;
                            updateEditorStatus('Modified');
                        }
                        updateLineInfo();
                        updateCharCount();
                    });
                    
                    // Update cursor position
                    monacoEditor.onDidChangeCursorPosition(() => {
                        updateLineInfo();
                    });
                    
                    // Add keyboard shortcut for save (Ctrl+S / Cmd+S)
                    monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                        if (currentFileKey && hasUnsavedChanges) {
                            saveFile();
                        }
                    });
                    
                    // Force layout after creation to ensure proper rendering
                    setTimeout(() => {
                        monacoEditor.layout();
                    }, 100);
                }
            });
        }
        
        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
                
                // Initialize Monaco Editor when File Editor tab is clicked
                if (tabId === 'file-editor') {
                    setTimeout(() => {
                        initMonacoEditor();
                        // Force layout if editor exists
                        if (monacoEditor) {
                            monacoEditor.layout();
                        }
                    }, 100);
                }
            });
        });
        
        // Initialize Monaco Editor immediately on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a short moment for DOM to be fully ready
            setTimeout(() => {
                initMonacoEditor();
                // If File Editor tab is active, ensure layout
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.getAttribute('data-tab') === 'file-editor') {
                    if (monacoEditor) {
                        monacoEditor.layout();
                    }
                }
            }, 300);
        });
        
        // Option switching
        document.querySelectorAll('.option-button').forEach(button => {
            button.addEventListener('click', function() {
                const parent = this.parentElement;
                const optionType = this.getAttribute('data-option') || this.getAttribute('data-script-location');
                
                // Remove active class from all buttons in this group
                parent.querySelectorAll('.option-button').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Show the selected option content if applicable
                if (this.getAttribute('data-option')) {
                    document.querySelectorAll('.option-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(optionType)?.classList.add('active');
                }
            });
        });
        
        // Enable search & replace toggle
        document.getElementById('enable-search-replace')?.addEventListener('change', function() {
            document.getElementById('search-replace-options').style.display = this.checked ? 'block' : 'none';
        });
        
        // Load AWS accounts on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
        });
        
        // Event Listeners
        document.getElementById('script-account-select').addEventListener('change', function() {
            loadBuckets(this.value);
        });
        
        document.getElementById('bucket-select').addEventListener('change', function() {
            const bucketName = this.value;
            const accountKey = document.getElementById('script-account-select').value;
            loadBucketFiles(bucketName, accountKey);
        });
        
        document.getElementById('source-account-select').addEventListener('change', function() {
            loadSourceBuckets(this.value);
        });
        
        document.getElementById('source-bucket-select').addEventListener('change', function() {
            const accountKey = document.getElementById('source-account-select').value;
            loadSourceFiles(this.value, accountKey);
        });
        
        document.getElementById('target-account-select').addEventListener('change', function() {
            loadTargetBuckets(this.value);
        });
        
        document.getElementById('edit-account-select').addEventListener('change', function() {
            loadEditBuckets(this.value);
        });
        
        document.getElementById('edit-bucket-select').addEventListener('change', function() {
            loadFileTree(this.value, document.getElementById('edit-account-select').value);
        });
        
        // Editor control buttons
        document.getElementById('save-button').addEventListener('click', saveFile);
        document.getElementById('reload-button').addEventListener('click', reloadFile);
        document.getElementById('format-button').addEventListener('click', formatCode);
        document.getElementById('find-next-btn').addEventListener('click', findNext);
        document.getElementById('replace-btn').addEventListener('click', replaceNext);
        document.getElementById('replace-all-btn').addEventListener('click', replaceAll);
        
        // Basic textarea change tracking
        document.getElementById('basic-file-content').addEventListener('input', function() {
            if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                document.getElementById('save-button').disabled = false;
                updateEditorStatus('Modified');
            }
            updateCharCount();
        });
        
        // Load accounts function
        async function loadAccounts() {
            try {
                log('Loading AWS accounts...');
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                const accountSelects = [
                    document.getElementById('account-select'),
                    document.getElementById('script-account-select'),
                    document.getElementById('source-account-select'),
                    document.getElementById('target-account-select'),
                    document.getElementById('edit-account-select')
                ];
                
                accountSelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Select an account...</option>';
                        if (data.accounts && Array.isArray(data.accounts)) {
                            data.accounts.forEach(account => {
                                const option = document.createElement('option');
                                option.value = account.key;
                                option.textContent = `${account.name} (${account.region})`;
                                select.appendChild(option);
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
                showStatus('domainStatus', 'Error loading accounts: ' + error.message, 'error');
            }
        }
        
        // Load buckets functions
        async function loadBuckets(accountKey) {
            if (!accountKey) return;
            
            try {
                const response = await fetch(`/api/buckets/${accountKey}`);
                const data = await response.json();
                
                const bucketSelect = document.getElementById('bucket-select');
                bucketSelect.innerHTML = '<option value="">Select a bucket...</option>';
                
                if (data.buckets) {
                    data.buckets.forEach(bucket => {
                        const option = document.createElement('option');
                        option.value = bucket.name;
                        option.textContent = bucket.name;
                        bucketSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading buckets:', error);
            }
        }
        
        async function loadSourceBuckets(accountKey) {
            if (!accountKey) return;
            
            try {
                const response = await fetch(`/api/buckets/${accountKey}`);
                const data = await response.json();
                
                const bucketSelect = document.getElementById('source-bucket-select');
                bucketSelect.innerHTML = '<option value="">Select a bucket...</option>';
                
                if (data.buckets) {
                    data.buckets.forEach(bucket => {
                        const option = document.createElement('option');
                        option.value = bucket.name;
                        option.textContent = bucket.name;
                        bucketSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading source buckets:', error);
            }
        }
        
        async function loadTargetBuckets(accountKey) {
            if (!accountKey) return;
            
            try {
                const response = await fetch(`/api/buckets/${accountKey}`);
                const data = await response.json();
                
                const bucketSelect = document.getElementById('target-bucket-select');
                bucketSelect.innerHTML = '<option value="">Select a bucket...</option>';
                
                if (data.buckets) {
                    data.buckets.forEach(bucket => {
                        const option = document.createElement('option');
                        option.value = bucket.name;
                        option.textContent = bucket.name;
                        bucketSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading target buckets:', error);
            }
        }
        
        async function loadEditBuckets(accountKey) {
            if (!accountKey) return;
            
            try {
                const response = await fetch(`/api/buckets/${accountKey}`);
                const data = await response.json();
                
                const bucketSelect = document.getElementById('edit-bucket-select');
                bucketSelect.innerHTML = '<option value="">Select a bucket...</option>';
                
                if (data.buckets) {
                    data.buckets.forEach(bucket => {
                        const option = document.createElement('option');
                        option.value = bucket.name;
                        option.textContent = bucket.name;
                        bucketSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading edit buckets:', error);
            }
        }
        
        // Load files functions
        async function loadBucketFiles(bucketName, accountKey) {
            if (!bucketName || !accountKey) return;
            
            try {
                const response = await fetch(`/api/bucket-files/${accountKey}/${bucketName}`);
                const data = await response.json();
                
                const fileSelect = document.getElementById('file-select');
                fileSelect.innerHTML = '<option value="">Select a file...</option>';
                
                if (data.files) {
                    const htmlFiles = data.files.filter(file => 
                        file.key.endsWith('.html') || file.key.endsWith('.htm')
                    );
                    
                    htmlFiles.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.key;
                        option.textContent = file.key;
                        fileSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }
        
        async function loadSourceFiles(bucketName, accountKey) {
            if (!bucketName || !accountKey) return;
            
            const filesDiv = document.getElementById('source-files');
            filesDiv.innerHTML = '<p style="color: #697078; text-align: center;">Loading...</p>';
            
            try {
                const response = await fetch(`/api/bucket-contents/${accountKey}/${bucketName}`);
                const data = await response.json();
                
                filesDiv.innerHTML = '';
                
                if (data.contents && data.contents.length > 0) {
                    // Create a container for better organization
                    const containerDiv = document.createElement('div');
                    containerDiv.style.padding = '8px';
                    
                    // Separate folders and files
                    const folders = data.contents.filter(item => item.type === 'folder');
                    const files = data.contents.filter(item => item.type === 'file');
                    
                    // Add folders first
                    folders.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-wrapper';
                        div.style.marginBottom = '8px';
                        div.style.padding = '4px';
                        div.style.borderRadius = '4px';
                        div.style.transition = 'background-color 0.15s';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = item.key;
                        checkbox.id = `folder-${item.key}`;
                        checkbox.className = 'folder-checkbox';
                        checkbox.style.marginRight = '8px';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `folder-${item.key}`;
                        label.style.cursor = 'pointer';
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.innerHTML = `
                            <span class="folder-icon" style="margin-right: 8px;">📁</span>
                            <span style="font-weight: 500;">${item.name || item.key}</span>
                        `;
                        
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        
                        // Add hover effect
                        div.onmouseover = () => div.style.backgroundColor = '#F2F3F3';
                        div.onmouseout = () => div.style.backgroundColor = 'transparent';
                        
                        containerDiv.appendChild(div);
                    });
                    
                    // Add a separator if there are both folders and files
                    if (folders.length > 0 && files.length > 0) {
                        const separator = document.createElement('div');
                        separator.style.borderTop = '1px solid #E3E6E8';
                        separator.style.margin = '12px 0';
                        containerDiv.appendChild(separator);
                    }
                    
                    // Add files
                    files.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-wrapper';
                        div.style.marginBottom = '4px';
                        div.style.padding = '4px';
                        div.style.borderRadius = '4px';
                        div.style.transition = 'background-color 0.15s';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = item.key;
                        checkbox.id = `file-${item.key}`;
                        checkbox.className = 'file-checkbox';
                        checkbox.style.marginRight = '8px';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `file-${item.key}`;
                        label.style.cursor = 'pointer';
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.innerHTML = `
                            <span class="file-icon" style="margin-right: 8px;">📄</span>
                            <span>${item.name || item.key}</span>
                        `;
                        
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        
                        // Add hover effect
                        div.onmouseover = () => div.style.backgroundColor = '#F2F3F3';
                        div.onmouseout = () => div.style.backgroundColor = 'transparent';
                        
                        containerDiv.appendChild(div);
                    });
                    
                    filesDiv.appendChild(containerDiv);
                } else {
                    filesDiv.innerHTML = '<p style="color: #697078; text-align: center;">No files or folders found</p>';
                }
            } catch (error) {
                console.error('Error loading source files:', error);
                filesDiv.innerHTML = '<p style="color: #697078; text-align: center;">Error loading files</p>';
            }
        }
        
        async function loadFileTree(bucketName, accountKey) {
            if (!bucketName || !accountKey) return;
            
            currentBucketName = bucketName;
            currentAccountKey = accountKey;
            
            const treeDiv = document.getElementById('file-tree');
            treeDiv.innerHTML = '<p style="color: #697078; text-align: center;">Loading...</p>';
            
            try {
                const response = await fetch(`/api/bucket-contents/${accountKey}/${bucketName}`);
                const data = await response.json();
                
                treeDiv.innerHTML = '';
                
                if (data.contents && data.contents.length > 0) {
                    // Separate folders and files
                    const folders = data.contents.filter(item => item.type === 'folder');
                    const files = data.contents.filter(item => item.type === 'file');
                    
                    // Render folders first
                    folders.forEach(folder => {
                        const folderElement = createFolderElement(folder, accountKey, bucketName);
                        treeDiv.appendChild(folderElement);
                    });
                    
                    // Then render files
                    files.forEach(file => {
                        const fileElement = createFileElement(file, bucketName, accountKey);
                        treeDiv.appendChild(fileElement);
                    });
                } else {
                    treeDiv.innerHTML = '<p style="color: #697078; text-align: center;">No files or folders found</p>';
                }
            } catch (error) {
                console.error('Error loading file tree:', error);
                treeDiv.innerHTML = '<p style="color: #697078; text-align: center;">Error loading files</p>';
            }
        }
        
        function createFolderElement(folder, accountKey, bucketName) {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder-item';
            
            const folderHeader = document.createElement('div');
            folderHeader.className = 'folder-header';
            folderHeader.innerHTML = `
                <span class="expand-btn">▶</span>
                <span class="folder-icon">📁</span>
                <span>${folder.name || folder.key.replace(/\/$/, '')}</span>
            `;
            
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'folder-content';
            childrenDiv.style.display = 'none';
            
            // Add click handler for expand/collapse
            folderHeader.addEventListener('click', async function(e) {
                e.stopPropagation();
                const expandIcon = folderHeader.querySelector('.expand-btn');
                const isExpanded = childrenDiv.style.display !== 'none';
                
                if (isExpanded) {
                    // Collapse
                    childrenDiv.style.display = 'none';
                    expandIcon.textContent = '▶';
                } else {
                    // Expand
                    childrenDiv.style.display = 'block';
                    expandIcon.textContent = '▼';
                    
                    // Load children if not already loaded
                    if (childrenDiv.children.length === 0) {
                        childrenDiv.innerHTML = '<div style="color: #697078; margin-left: 20px;">Loading...</div>';
                        await loadFolderContents(folder.key, childrenDiv, accountKey, bucketName);
                    }
                }
            });
            
            folderDiv.appendChild(folderHeader);
            folderDiv.appendChild(childrenDiv);
            
            return folderDiv;
        }
        
        function createFileElement(file, bucketName, accountKey) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.innerHTML = `
                <span class="file-icon">📄</span>
                <span>${file.name || file.key}</span>
            `;
            
            fileDiv.addEventListener('click', function() {
                // Remove selected class from all files
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
                // Add selected class to this file
                fileDiv.classList.add('selected');
                // Load file content
                loadFileContent(file.key, bucketName, accountKey);
            });
            
            return fileDiv;
        }
        
        async function loadFolderContents(folderKey, containerElement, accountKey, bucketName) {
            try {
                const response = await fetch(`/api/bucket-contents/${accountKey}/${bucketName}?prefix=${encodeURIComponent(folderKey)}`);
                const data = await response.json();
                
                containerElement.innerHTML = '';
                
                if (!data.contents || data.contents.length === 0) {
                    containerElement.innerHTML = '<div style="color: #697078; margin-left: 20px;">Empty folder</div>';
                    return;
                }
                
                // Separate folders and files
                const folders = data.contents.filter(item => item.type === 'folder');
                const files = data.contents.filter(item => item.type === 'file');
                
                // Render folders first
                folders.forEach(folder => {
                    const folderElement = createFolderElement(folder, accountKey, bucketName);
                    containerElement.appendChild(folderElement);
                });
                
                // Then render files
                files.forEach(file => {
                    const fileElement = createFileElement(file, bucketName, accountKey);
                    containerElement.appendChild(fileElement);
                });
                
            } catch (error) {
                console.error('Error loading folder contents:', error);
                containerElement.innerHTML = '<div style="color: #697078; margin-left: 20px;">Error loading folder</div>';
            }
        }
        
        async function loadFileContent(fileKey, bucketName, accountKey) {
            try {
                currentFileKey = fileKey;
                currentBucketName = bucketName;
                currentAccountKey = accountKey;
                
                const response = await fetch(`/api/get-file-content/${accountKey}/${bucketName}/${fileKey}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Update file name display
                    document.getElementById('current-file').textContent = fileKey;
                    
                    // Detect file type and set appropriate language mode
                    const fileExtension = fileKey.split('.').pop().toLowerCase();
                    let language = 'plaintext';
                    
                    const languageMap = {
                        'js': 'javascript',
                        'jsx': 'javascript',
                        'ts': 'typescript',
                        'tsx': 'typescript',
                        'html': 'html',
                        'htm': 'html',
                        'css': 'css',
                        'scss': 'scss',
                        'json': 'json',
                        'xml': 'xml',
                        'py': 'python',
                        'java': 'java',
                        'c': 'c',
                        'cpp': 'cpp',
                        'cs': 'csharp',
                        'php': 'php',
                        'rb': 'ruby',
                        'go': 'go',
                        'rs': 'rust',
                        'kt': 'kotlin',
                        'swift': 'swift',
                        'md': 'markdown',
                        'yaml': 'yaml',
                        'yml': 'yaml',
                        'sql': 'sql',
                        'sh': 'shell',
                        'bash': 'shell',
                        'dockerfile': 'dockerfile',
                        'makefile': 'makefile'
                    };
                    
                    if (languageMap[fileExtension]) {
                        language = languageMap[fileExtension];
                    }
                    
                    // Update content in editor
                    if (monacoEditor) {
                        const model = monaco.editor.createModel(data.content, language);
                        monacoEditor.setModel(model);
                        document.getElementById('editor-mode').textContent = language.charAt(0).toUpperCase() + language.slice(1);
                    } else {
                        document.getElementById('basic-file-content').value = data.content;
                    }
                    
                    // Reset save state
                    hasUnsavedChanges = false;
                    document.getElementById('save-button').disabled = true;
                    document.getElementById('reload-button').disabled = false;
                    document.getElementById('format-button').disabled = false;
                    
                    updateEditorStatus('Ready');
                    updateCharCount();
                    updateLineInfo();
                    
                    // Highlight selected file
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('selected');
                        if (item.textContent.includes(fileKey)) {
                            item.classList.add('selected');
                        }
                    });
                } else {
                    showStatus('editorStatus', data.error || 'Failed to load file', 'error');
                }
            } catch (error) {
                showStatus('editorStatus', 'Error loading file: ' + error.message, 'error');
            }
        }
        
        async function saveFile() {
            if (!currentFileKey || !currentBucketName || !currentAccountKey) {
                showStatus('editorStatus', 'No file selected', 'error');
                return;
            }
            
            const content = monacoEditor ? monacoEditor.getValue() : document.getElementById('basic-file-content').value;
            
            try {
                updateEditorStatus('Saving...');
                
                const response = await fetch('/api/save-file-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account: currentAccountKey,
                        bucket: currentBucketName,
                        file: currentFileKey,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('editorStatus', 'File saved successfully', 'success');
                    hasUnsavedChanges = false;
                    document.getElementById('save-button').disabled = true;
                    updateEditorStatus('Saved');
                    
                    setTimeout(() => {
                        updateEditorStatus('Ready');
                    }, 2000);
                } else {
                    showStatus('editorStatus', data.error || 'Save failed', 'error');
                    updateEditorStatus('Error');
                }
            } catch (error) {
                showStatus('editorStatus', 'Error: ' + error.message, 'error');
                updateEditorStatus('Error');
            }
        }
        
        function reloadFile() {
            if (currentFileKey && hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to reload?')) {
                    return;
                }
            }
            
            if (currentFileKey) {
                loadFileContent(currentFileKey, currentBucketName, currentAccountKey);
            }
        }
        
        function formatCode() {
            if (monacoEditor) {
                monacoEditor.getAction('editor.action.formatDocument').run();
                showStatus('editorStatus', 'Code formatted', 'success');
            }
        }
        
        function findNext() {
            const searchText = document.getElementById('search-in-file').value;
            if (!searchText) return;
            
            if (monacoEditor) {
                monacoEditor.getModel().findMatches(searchText);
                monacoEditor.getAction('actions.find').run();
            } else {
                // Basic search for textarea
                const textarea = document.getElementById('basic-file-content');
                const content = textarea.value;
                const index = content.indexOf(searchText, textarea.selectionEnd);
                
                if (index !== -1) {
                    textarea.setSelectionRange(index, index + searchText.length);
                    textarea.focus();
                }
            }
        }
        
        function replaceNext() {
            const searchText = document.getElementById('search-in-file').value;
            const replaceText = document.getElementById('replace-in-file').value;
            
            if (!searchText) return;
            
            if (monacoEditor) {
                const model = monacoEditor.getModel();
                const matches = model.findMatches(searchText);
                if (matches.length > 0) {
                    const range = matches[0].range;
                    monacoEditor.executeEdits('replace', [{
                        range: range,
                        text: replaceText
                    }]);
                }
            } else {
                // Basic replace for textarea
                const textarea = document.getElementById('basic-file-content');
                const content = textarea.value;
                const newContent = content.replace(searchText, replaceText);
                textarea.value = newContent;
                
                if (!hasUnsavedChanges) {
                    hasUnsavedChanges = true;
                    document.getElementById('save-button').disabled = false;
                    updateEditorStatus('Modified');
                }
            }
        }
        
        function replaceAll() {
            const searchText = document.getElementById('search-in-file').value;
            const replaceText = document.getElementById('replace-in-file').value;
            
            if (!searchText) return;
            
            if (monacoEditor) {
                const model = monacoEditor.getModel();
                const matches = model.findMatches(searchText);
                const edits = matches.map(match => ({
                    range: match.range,
                    text: replaceText
                }));
                monacoEditor.executeEdits('replaceAll', edits);
            } else {
                // Basic replace all for textarea
                const textarea = document.getElementById('basic-file-content');
                const content = textarea.value;
                const newContent = content.replaceAll(searchText, replaceText);
                textarea.value = newContent;
                
                if (!hasUnsavedChanges) {
                    hasUnsavedChanges = true;
                    document.getElementById('save-button').disabled = false;
                    updateEditorStatus('Modified');
                }
            }
            
            showStatus('editorStatus', `Replaced all occurrences`, 'success');
        }
        
        function updateLineInfo() {
            if (monacoEditor) {
                const position = monacoEditor.getPosition();
                document.getElementById('line-info').textContent = `Line ${position.lineNumber}, Col ${position.column}`;
            } else {
                const textarea = document.getElementById('basic-file-content');
                const lines = textarea.value.substr(0, textarea.selectionStart).split('\n');
                const currentLine = lines.length;
                const currentCol = lines[lines.length - 1].length + 1;
                document.getElementById('line-info').textContent = `Line ${currentLine}, Col ${currentCol}`;
            }
        }
        
        function updateCharCount() {
            const content = monacoEditor ? monacoEditor.getValue() : document.getElementById('basic-file-content').value;
            const charCount = content.length;
            const lineCount = content.split('\n').length;
            document.getElementById('char-count').textContent = `${charCount} characters, ${lineCount} lines`;
        }
        
        function updateEditorStatus(status) {
            document.getElementById('editor-status').textContent = status;
        }
        
        // Domain setup form submission
        document.getElementById('domainForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const account = document.getElementById('account-select').value;
            const domain = document.getElementById('domain').value;
            
            if (!account || !domain) {
                showStatus('domainStatus', 'Please fill in all required fields', 'error');
                return;
            }
            
            this.querySelector('button').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('stepList').innerHTML = '';
            document.getElementById('domainSection').style.display = 'none';
            
            try {
                const response = await fetch('/api/setup-domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account, domain })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('domainStatus', data.message, 'success');
                    
                    if (data.tasks && data.tasks.length > 0) {
                        data.tasks.forEach(task => {
                            pollStatus(task.task_id);
                        });
                    }
                } else {
                    showStatus('domainStatus', data.error || 'Setup failed', 'error');
                    this.querySelector('button').disabled = false;
                }
            } catch (error) {
                showStatus('domainStatus', 'Error: ' + error.message, 'error');
                this.querySelector('button').disabled = false;
            }
        });
        
        // Replace script button
        document.getElementById('replace-script-btn').addEventListener('click', async function() {
            const account = document.getElementById('script-account-select').value;
            const bucket = document.getElementById('bucket-select').value;
            const file = document.getElementById('file-select').value;
            const findText = document.getElementById('find-text').value;
            const replaceText = document.getElementById('replace-text').value;
            
            if (!account || !bucket || !file || !findText) {
                showStatus('scriptStatus', 'Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/replace-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account,
                        bucket,
                        file,
                        find: findText,
                        replace: replaceText
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('scriptStatus', data.message, 'success');
                    document.getElementById('find-text').value = '';
                    document.getElementById('replace-text').value = '';
                } else {
                    showStatus('scriptStatus', data.error || 'Operation failed', 'error');
                }
            } catch (error) {
                showStatus('scriptStatus', 'Error: ' + error.message, 'error');
            }
        });
        
        // Add script button
        document.getElementById('add-script-btn').addEventListener('click', async function() {
            const account = document.getElementById('script-account-select').value;
            const bucket = document.getElementById('bucket-select').value;
            const file = document.getElementById('file-select').value;
            const scriptText = document.getElementById('script-text').value;
            const location = document.querySelector('[data-script-location].active')?.getAttribute('data-script-location') || 'head';
            
            if (!account || !bucket || !file || !scriptText) {
                showStatus('scriptStatus', 'Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/add-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account,
                        bucket,
                        file,
                        location,
                        script: scriptText
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('scriptStatus', data.message, 'success');
                    document.getElementById('script-text').value = '';
                } else {
                    showStatus('scriptStatus', data.error || 'Operation failed', 'error');
                }
            } catch (error) {
                showStatus('scriptStatus', 'Error: ' + error.message, 'error');
            }
        });
        
        // Copy files button
        document.getElementById('copy-files-btn').addEventListener('click', async function() {
            const sourceAccount = document.getElementById('source-account-select').value;
            const sourceBucket = document.getElementById('source-bucket-select').value;
            const targetAccount = document.getElementById('target-account-select').value;
            const targetBucket = document.getElementById('target-bucket-select').value;
            
            const selectedFolders = Array.from(document.querySelectorAll('.folder-checkbox:checked')).map(cb => cb.value);
            const selectedFiles = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
            
            if (!sourceAccount || !sourceBucket || !targetAccount || !targetBucket) {
                showStatus('copyStatus', 'Please select source and target', 'error');
                return;
            }
            
            if (selectedFolders.length === 0 && selectedFiles.length === 0) {
                showStatus('copyStatus', 'Please select files or folders to copy', 'error');
                return;
            }
            
            const enableSearchReplace = document.getElementById('enable-search-replace').checked;
            const searchTerms = enableSearchReplace ? document.getElementById('search-terms').value : '';
            const replaceTerms = enableSearchReplace ? document.getElementById('replace-terms').value : '';
            
            try {
                const response = await fetch('/api/copy-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceAccount,
                        sourceBucket,
                        targetAccount,
                        targetBucket,
                        selectedFolders,
                        selectedFiles,
                        enableSearchReplace,
                        searchTerms,
                        replaceTerms
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('copyStatus', data.message, 'success');
                } else {
                    showStatus('copyStatus', data.error || 'Copy failed', 'error');
                }
            } catch (error) {
                showStatus('copyStatus', 'Error: ' + error.message, 'error');
            }
        });
        
        // Poll status function
        async function pollStatus(taskId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/status/${taskId}`);
                    const data = await response.json();
                    
                    updateProgress(data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        document.getElementById('domainForm').querySelector('button').disabled = false;
                        document.getElementById('progressContainer').style.display = 'none';
                        
                        if (data.status === 'completed') {
                            showDomainInfo(data);
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 2000);
        }
        
        // Update progress function
        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const stepList = document.getElementById('stepList');
            
            if (data.progress) {
                progressText.textContent = data.progress;
            }
            
            if (data.steps) {
                stepList.innerHTML = '';
                Object.entries(data.steps).forEach(([key, step]) => {
                    const li = document.createElement('li');
                    li.className = 'step-item';
                    
                    if (step.status === 'completed') {
                        li.classList.add('completed');
                        li.innerHTML = `
                            <span class="step-icon">✓</span>
                            <span>${step.message || key}</span>
                        `;
                    } else if (step.status === 'in_progress') {
                        li.classList.add('in-progress');
                        li.innerHTML = `
                            <span class="step-icon">⟳</span>
                            <span>${step.message || key}</span>
                        `;
                    } else if (step.status === 'failed') {
                        li.classList.add('failed');
                        li.innerHTML = `
                            <span class="step-icon">✗</span>
                            <span>${step.message || key}</span>
                        `;
                    }
                    
                    stepList.appendChild(li);
                });
                
                const totalSteps = Object.keys(data.steps).length;
                const completedSteps = Object.values(data.steps).filter(s => s.status === 'completed').length;
                const percentage = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
                progressBar.style.width = percentage + '%';
            }
        }
        
        // Show domain info function
        function showDomainInfo(data) {
            const section = document.getElementById('domainSection');
            section.style.display = 'block';
            
            let html = `<h3>Setup Complete for ${data.domain}</h3>`;
            
            if (data.cloudfront_url) {
                html += `<p><strong>CloudFront URL:</strong> <a href="https://${data.cloudfront_url}" target="_blank">${data.cloudfront_url}</a></p>`;
            }
            
            if (data.nameservers && data.nameservers.length > 0) {
                html += `
                    <div class="manual-steps">
                        <h4>Next Steps: Update Domain Nameservers</h4>
                        <p>Update your domain registrar with these nameservers:</p>
                        <ul>
                            ${data.nameservers.map(ns => `<li><code>${ns}</code></li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            section.innerHTML = html;
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${type}`;
                element.textContent = message;
                element.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 5000);
                }
            }
        }
    </script>
    
    <!-- Footer -->
    <div style="background-color: #232F3E; color: white; text-align: center; padding: 20px; margin-top: 40px;">
        <p style="margin: 0; font-size: 14px; opacity: 0.9;">
            © 2025 ATOM - Automated Tasks & Operations Manager by PearMedia LLC. All rights reserved.
        </p>
    </div>
</body>
</html>